version: 0.2

env:
  git-credential-helper: yes

phases:
  install:
    runtime-versions:
      nodejs: 14
    commands:
      - yarn
  pre_build:
    commands:
      - git config --global user.email "petersonvgama@gmail.com"
      - git config --global user.name "Serenity - CodeBuild"
  build:
    commands:
      - yarn build
  post_build:
    commands:
      - git checkout main
      - yarn version --patch
      - export VERSION=`yarn --silent current-version`
      - sed -i "s/guanabara_status_be\/.*\/$/guanabara_status_be\/${VERSION}\/" appspec.yml
      - zip -r -q build.zip bin/ node_modules/ package.json .env-cmdrc appspec.yml buildspec.yml
      - git commit -a -m "Bumping version ${VERSION}"
      - git push origin HEAD:main
      - git push origin HEAD:main --tags
artifacts:
  files:
    - build.zip
  name: guanabara_status_be/`yarn --silent current-version`